{
    "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
    "handler": "Microsoft.Azure.CreateUIDef",
    "version": "0.1.2-preview",
    "parameters": {
        "basics": [ {
                "name": "baseName",
                "type": "Microsoft.Common.TextBox",
                "label": "Base resource name",
                "toolTip": "The base name of the services. Most services will be appended with a service name (i.e. -postgres).",
                "constraints": {
                    "required": true,
                    "regex": "^[a-z0-9A-Z]{1,30}$",
                    "validationMessage": "Only alphanumeric characters are allowed, and the value must be 1-30 characters long."
                },
                "visible": true
            } ],
        "steps": [
			{
                "name": "admeDetails",
                "label": "Details",
                "elements": [
					{
						"name": "admeInstanceDetails",
						"type": "Microsoft.Common.Section",
						"label": "Instance Details",
						"elements": [
							{
								"name": "admeInstanceDetailsDescription",
								"type": "Microsoft.Common.TextBlock",
								"visible": true,
								"options": {
									"text": "Please provide the configuration values for your Azure Data Manager for Energy (ADME) instance."
								}
							},
							{
								"name": "admeEndpoint",
								"type": "Microsoft.Common.TextBox",
								"label": "Endpoint",
								"toolTip": "The base URL of the ADME instance",
								"defaultValue": "https://<contoso>.energy.azure.com",
								"constraints": {
									"required": true,
									"regex": "^https://[a-zA-Z0-9-]{1,31}\\.energy\\.azure\\.com$",
									"validationMessage": "The ADME endpoint must be a valid URL"
								},
								"visible": true
							},
							{
								"name": "admeDataPartition",
								"type": "Microsoft.Common.TextBox",
								"label": "Data Partition",
								"toolTip": "The data partition ID for the ADME instance",
								"defaultValue": "data",
								"constraints": {
									"required": true,
									"regex": "^[a-zA-Z0-9-]{1,31}$",
									"validationMessage": "The ADME data partition must be a valid string"
								},
								"visible": true
							},
							{
								"name": "admeScope",
								"type": "Microsoft.Common.TextBox",
								"label": "Scope",
								"toolTip": "The scope used by the ADME instance",
								"placeholder": "00000000-0000-0000-0000-000000000000/.default",
								"constraints": {
									"required": true,
									"regex": "^[A-Za-z0-9]{8}-[A-Za-z0-9]{4}-[A-Za-z0-9]{4}-[A-Za-z0-9]{4}-[A-Za-z0-9]{12}/.*$",
									"validationMessage": "The ADME data partition must be a valid GUID followed by a /"
								},
								"visible": true
							},
							{
								"name": "admeLegalTag",
								"type": "Microsoft.Common.TextBox",
								"label": "Legal Tag",
								"toolTip": "The legal tag used by the file ingestion through Production DMS",
								"defaultValue": "",
								"constraints": {
									"required": true,
									"regex": "^[a-zA-Z0-9-]+$",
									"validationMessage": "The ADME legal tag must be a valid string"
								}
							},
							{
								"name": "admeLegalTagInfo",
								"type": "Microsoft.Common.InfoBox",
								"visible": "[not(equals(steps('admeDetails').admeInstanceDetails.admeLegalTag, ''))]",
								"options": {
									"icon": "Info",
									"text": "The legal tag is used by files ingested through the Production DMS. Please ensure this is set correctly for your deployment, and that the legal tag already exist in the data partition."
								}
							}
						],
						"visible": true
					},
					{
						"name": "admeConnectionDetails",
						"type": "Microsoft.Common.Section",
						"label": "Credentials",
						"elements": [
							{
								"name": "admeConnectionDetailsDescription",
								"type": "Microsoft.Common.TextBlock",
								"visible": true,
								"options": {
									"text": "Please provide credentials for an App Registration with permission to read the ADME Partition API."
								}
							},
							{
								"name": "admeClientId",
								"type": "Microsoft.Common.TextBox",
								"label": "Client ID",
								"toolTip": "The client ID used to access the ADME Partition API",
								"placeholder": "00000000-0000-0000-0000-000000000000",
								"constraints": {
									"required": true,
									"regex": "^[A-Za-z0-9]{8}-[A-Za-z0-9]{4}-[A-Za-z0-9]{4}-[A-Za-z0-9]{4}-[A-Za-z0-9]{12}$",
									"validationMessage": "Must be a valid client ID"
								},
								"visible": true
							},
							{
								"name": "admeClientSecret",
								"type": "Microsoft.Common.PasswordBox",
								"label": {
								  "password": "Client secret",
								  "confirmPassword": "Confirm client secret"
								},
								"toolTip": "The client secret for the ADME deployment",
								"constraints": {
								  "required": true,
								  "regex": "^[a-zA-Z0-9-_.~]{40,40}$",
								  "validationMessage": "Must be a valid secret"
								},
								"options": {
								  "hideConfirmation": true
								},
								"visible": true
							  }
						],
						"visible": true
					}
                ]
            },
			{
                "name": "container",
                "label": "Container",
                "elements": [
					{
						"name": "containerSection1",
						"type": "Microsoft.Common.Section",
						"label": "Container image",
						"elements": [
							{
								"name": "containerImage",
								"type": "Microsoft.Common.TextBlock",
								"visible": true,
								"options": {
									"text": "Provide a URL to the container images to use.",
									"link": {
										"label": "Learn more",
										"uri": "https://community.opengroup.org/osdu/platform/domain-data-mgmt-services/production/core/dspdm-services/container_registry"
									}
								}
							},
							{
								"name": "containerImageService",
								"type": "Microsoft.Common.TextBox",
								"label": "Service",
								"defaultValue": "community.opengroup.org:5555/osdu/platform/domain-data-mgmt-services/production/core/dspdm-services/gc-dspdm-master:latest",
								"toolTip": "Service container image URL",
								"constraints": {
									"required": true,
									"regex": "^(?:[a-z0-9]+(?:[._-][a-z0-9]+)*)(?::[0-9]+)?(?:/[a-z0-9]+(?:[._-][a-z0-9]+)*)*(?:/[a-zA-Z0-9._-]+)*(:[a-zA-Z0-9._-]+)?$",
									"validationMessage": "Only alphanumeric characters are allowed."
								},
								"visible": true
							},
							{
								"name": "containerImageInit",
								"type": "Microsoft.Common.TextBox",
								"label": "Init",
								"placeholder": "",
								"defaultValue": "community.opengroup.org:5555/osdu/platform/domain-data-mgmt-services/production/core/dspdm-services/gc-bootstrap-dspdm-master:latest",
								"toolTip": "Init container image URL",
								"constraints": {
									"required": true,
									"regex": "^(?:[a-z0-9]+(?:[._-][a-z0-9]+)*)(?::[0-9]+)?(?:/[a-z0-9]+(?:[._-][a-z0-9]+)*)*(?:/[a-zA-Z0-9._-]+)*(:[a-zA-Z0-9._-]+)?$",
									"validationMessage": "Only alphanumeric characters are allowed."
								},
								"visible": true
							}
						],
						"visible": true
					},
					{
						"name": "containerSection2",
						"type": "Microsoft.Common.Section",
						"label": "Container configuration",
						"elements": [
							{
								"name": "containerTextblock",
								"type": "Microsoft.Common.TextBlock",
								"visible": true,
								"options": {
									"text": "The workload profile to use for the container app. Consumption uses the `Consumption` profile, while Premium uses the `D4` profile.",
									"link": {
										"label": "Learn more",
										"uri": "https://learn.microsoft.com/en-us/azure/container-apps/workload-profiles-overview#profile-types"
									}
								}
							},
							{
								"name": "containerWorkloadProfile",
								"type": "Microsoft.Common.DropDown",
								"label": "Workload profile",
								"placeholder": "",
								"defaultValue": "Consumption",
								"toolTip": "",
								"constraints": {
									"allowedValues": [
										{
											"label": "Consumption",
											"value": "Consumption"
										},
										{
											"label": "Premium",
											"value": "D4"
										}
									],
									"required": true
								},
								"visible": true
							}
						],
						"visible": true
					}
				]
            },
			{
                "name": "database",
                "label": "Database",
                "elements": [
					{
						"name": "databaseSection",
						"type": "Microsoft.Common.Section",
						"label": "Databases",
						"elements": [
							{
								"name": "databasesDescription",
								"type": "Microsoft.Common.TextBlock",
								"visible": true,
								"options": {
									"text": "The Production DMS requires two SQL databases to store it's data in. One for service information, and another for the model data.",
									"link": {
										"label": "Learn more",
										"uri": "https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/how-to-create-users#the-server-admin-account"
									}
								}
							},
							{
								"name": "modelDataseName",
								"defaultValue": "dspdm_model",
								"type": "Microsoft.Common.TextBox",
								"label": "Model database name"
							},
							{
								"name": "serviceDatabaseName",
								"defaultValue": "dspdm_service",
								"type": "Microsoft.Common.TextBox",
								"label": "Service database name"
							}
						],
						"visible": true
					},					{
						"name": "databaseAuthSection",
						"type": "Microsoft.Common.Section",
						"label": "Authentication",
						"elements": [
							{
								"name": "databaseDescription",
								"type": "Microsoft.Common.TextBlock",
								"visible": true,
								"options": {
									"text": "Please provide the username and password you want to use for the initial admin account of the Postgres Flexible Server.",
									"link": {
										"label": "Learn more",
										"uri": "https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/how-to-create-users#the-server-admin-account"
									}
								}
							},
							{
								"name": "databaseUsername",
								"type": "Microsoft.Compute.UserNameTextBox",
								"label": "Admin username",
								"defaultValue": "postgres",
								"toolTip": "The username of the admin for the Postgres Flexible Server",
								"constraints": {
									"required": true,
									"regex": "^[a-z0-9A-Z]{1,30}$",
									"validationMessage": "Only alphanumeric characters are allowed, and the value must be 1-30 characters long."
								},
								"osPlatform": "Windows",
								"visible": true
							},
							{
								"name": "databasePassword",
								"type": "Microsoft.Common.PasswordBox",
								"label": {
									"password": "Password",
									"confirmPassword": "Confirm password"
								},
								"toolTip": "The password of the admin for the Postgres Flexible Server",
								"constraints": {
									"required": true,
									"regex": "^[a-zA-Z0-9]{8,}$",
									"validationMessage": "Password must be at least 8 characters long, contain only numbers and letters"
								},
								"options": {
									"hideConfirmation": false
								},
								"visible": true
							}
						],
						"visible": true
					}

				]
			},
			{
                "name": "networking",
                "label": "Networking",
                "elements": [
					{
						"name": "networkingDescription",
						"type": "Microsoft.Common.TextBlock",
						"visible": true,
						"options": {
							"text": "By default the deployment uses public endpoints to expose the Production DMS APIs.",
							"link": {
								"label": "Learn more",
								"uri": ""
							}
						}
					},
					{
						"name": "enablePrivateEndpoint",
						"type": "Microsoft.Common.OptionsGroup",
						"label": "Use Private Endpoint?",
						"defaultValue": "No",
						"toolTip": "Setting to ''Yes'' will enable private networking to access the Production DMS APIs.",
						"constraints": {
							"allowedValues": [
								{
									"label": "Yes",
									"value": "true"
								},
								{
									"label": "No",
									"value": "false"
								}
							],
							"required": true
						},
						"visible": true
					},
					{
						"name": "privateEndpointSection",
						"type": "Microsoft.Common.Section",
						"label": "Private Endpoint properties",
						"visible": "[equals(steps('networking').enablePrivateEndpoint, 'true')]",
						"elements": [
							{
								"name": "vnet",
								"type": "Microsoft.Network.VirtualNetworkCombo",
								"label": {
									"virtualNetwork": "Virtual network",
									"subnets": "Subnets"
								},
								"toolTip": {
									"virtualNetwork": "",
									"subnets": ""
								},
								"defaultValue": {
									"name": "proddms-vnet",
									"addressPrefixSize": "/23"
								},
								"constraints": {
									"minAddressPrefixSize": "/23"
								},
								"options": {
									"hideExisting": false
								},
								"subnets": {
									"databaseSubnet": {
										"label": "Database subnet",
										"defaultValue": {
											"name": "database-subnet",
											"addressPrefixSize": "/24"
										},
										"constraints": {
											"minAddressPrefixSize": "/26",
											"minAddressCount": 8
										}
									},
									"containerSubnet": {
										"label": "Container subnet",
										"defaultValue": {
											"name": "container-subnet",
											"addressPrefixSize": "/24"
										},
										"constraints": {
											"minAddressPrefixSize": "/26",
											"minAddressCount": 8
										}
									}
								},
								"visible": true
							},
							{
								"name": "privateEndpointInfobox",
								"type": "Microsoft.Common.InfoBox",
								"visible": true,
								"options": {
									"icon": "Info",
									"text": "By enabling private networking, you will either need to be connected to the Virtual Network you deploy the service to, or expose it using other services.",
									"uri": "https://learn.microsoft.com/en-us/azure/api-management/api-management-key-concepts"
								}
							}
						]
					}
                ]
            }
        ],
        "outputs": {
            "outputs": {
                "name": "[basics('baseName')]",
                "privateEndpointEnabled": "[steps('networking').enablePrivateEndpoint]",
                "admeEndpoint": "[steps('admeDetails').admeInstanceDetails.admeEndpoint]",
                "admeDataPartition": "[steps('admeDetails').admeInstanceDetails.admeDataPartition]",
				"admeScope": "[steps('admeDetails').admeInstanceDetails.admeScope]",
				"admeLegalTag": "steps('admeDetails').admeInstanceDetails.admeLegalTag",
                "admeClientId": "[steps('admeDetails').admeConnectionDetails.admeClientId]",
                "admeClientSecret": "[steps('admeDetails').admeConnectionDetails.admeClientSecret]",
                "containerImageService": "[steps('container').containerSection1.containerImageService]",
                "containerImageInit": "[steps('container').containerSection1.containerImageInit]",
                "containerWorkloadProfile": "[steps('container').containerSection2.containerWorkloadProfile]",
                "databaseUsername": "[steps('database').databaseAuthSection.databaseUsername]",
                "databasePassword": "[steps('database').databaseAuthSection.databasePassword]",
				"modelDatabaseName": "[steps('database').databaseSection.modelDataseName]",
				"serviceDatabaseName": "[steps('database').databaseSection.serviceDatabaseName]",
                "enablePrivateEndpoint": "[steps('networking').enablePrivateEndpoint]",
                "vnet": "[steps('networking').privateEndpointSection.vnet]",
                "databaseSubnet": "[steps('networking').privateEndpointSection.vnet.subnets.databaseSubnet]",
                "containerSubnet": "[steps('networking').privateEndpointSection.vnet.subnets.containerSubnet]"
            }
        }
    }
}